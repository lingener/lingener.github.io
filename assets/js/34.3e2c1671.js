(window.webpackJsonp=window.webpackJsonp||[]).push([[34],{670:function(s,a,e){"use strict";e.r(a);var t=e(3),r=Object(t.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"网关"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#网关"}},[s._v("#")]),s._v(" 网关")]),s._v(" "),e("p",[s._v("Starter阿里云镜像")]),s._v(" "),e("p",[s._v("https://start.aliyun.com/")]),s._v(" "),e("h2",{attrs:{id:"概念"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#概念"}},[s._v("#")]),s._v(" 概念")]),s._v(" "),e("p",[s._v("服务治理，服务注册发现，服务调用，熔断。已经学完。")]),s._v(" "),e("p",[s._v("微服务基本模块已经有了，也可以做微服务了。但完成一个复杂的业务，可能需要多个微服务合作来完成，比如下单，需要用户服务，支付服务，地图服务，订单服务。一般是我们对外服务的窗口，进行服务内外隔离。一般微服务都在内网，不做安全验证，")]),s._v(" "),e("p",[s._v("就好像：很多明星，可以独立开演唱会（独立提供服务）。也可以去春晚（微服务群提供服务）。但一台春晚就不能让 观众一个一个调用了。观众要调用，需要检票啥的，检票就类似于网关，进来之后，界面随便看，不会说你 看个小品，还需要再检票。")]),s._v(" "),e("p",[s._v("微服务没有网关，会有下面的问题：")]),s._v(" "),e("ol",[e("li",[e("p",[s._v("客户端请求多个微服务，增加了客户端复杂性，每个微服务都要做用户认证，限流等，避免和多个微服务打交道的复杂性。")])]),s._v(" "),e("li",[e("p",[s._v("有跨域问题，不在同一个域。")])]),s._v(" "),e("li",[e("p",[s._v("认证复杂，每个服务都要独立认证，服务要求的权限不一致。")])]),s._v(" "),e("li",[e("p",[s._v("难以重构。因为微服务被客户端调用着，重构难以实施。")])])]),s._v(" "),e("p",[s._v("网关是介于客户端（外部调用方比如app，h5）和微服务的中间层。")]),s._v(" "),e("p",[s._v("Zuul是Netflix开源的微服务网关，核心是一系列过滤器。这些过滤器可以完成以下功能。")]),s._v(" "),e("ol",[e("li",[s._v("是所有微服务入口，进行分发。")]),s._v(" "),e("li",[s._v("身份认证与安全。识别合法的请求，拦截不合法的请求。")]),s._v(" "),e("li",[s._v("监控。在入口处监控，更全面。")]),s._v(" "),e("li",[s._v("动态路由。动态将请求分发到不同的后端集群。")]),s._v(" "),e("li",[s._v("压力测试。可以逐渐增加对后端服务的流量，进行测试。")]),s._v(" "),e("li",[s._v("负载均衡。也是用ribbon。")]),s._v(" "),e("li",[s._v("限流（望京超市）。比如我每秒只要1000次，10001次就不让访问了。")]),s._v(" "),e("li",[s._v("服务熔断")])]),s._v(" "),e("p",[s._v("网关和服务的关系：演员和剧场检票人员的关系。")]),s._v(" "),e("p",[s._v("zuul默认集成了：ribbon和hystrix。")]),s._v(" "),e("h2",{attrs:{id:"启用网关"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#启用网关"}},[s._v("#")]),s._v(" 启用网关")]),s._v(" "),e("p",[s._v("新建项目引入依赖")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\t\t<dependency>\n\t\t\t<groupId>org.springframework.cloud</groupId>\n\t\t\t<artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>\n\t\t</dependency>\n\t\t<dependency>\n\t\t\t<groupId>org.springframework.cloud</groupId>\n\t\t\t<artifactId>spring-cloud-starter-netflix-zuul</artifactId>\n\t\t</dependency>\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("配置文件")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("eureka.client.service-url.defaultZone=http://euk1.com:7001/eureka/\nspring.application.name=zuulserver\nserver.port=80\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("启动类")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("@EnableZuulProxy\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("测试访问")]),s._v(" "),e("p",[s._v("网关会将服务名转换成具体服务的ip和端口，实际进行访问")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("http://localhost/consumer/alive\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"负载均衡"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#负载均衡"}},[s._v("#")]),s._v(" 负载均衡")]),s._v(" "),e("p",[s._v("启动两个Consumer")]),s._v(" "),e("p",[s._v("轮询访问上面地址，会看到返回结果中，端口一直轮询在变。说明负载均衡生效了，默认是轮询")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("consumer.ribbon.NFLoadBalancerRuleClassName=com.netflix.loadbalancer.RandomRule\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"路由端点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#路由端点"}},[s._v("#")]),s._v(" 路由端点")]),s._v(" "),e("p",[s._v("调试的时候，看网关请求的地址，以及 映射是否正确。网关请求有误时，可以通过此处排查错误。")]),s._v(" "),e("p",[s._v("配置")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("management.endpoints.web.exposure.include=*\nmanagement.endpoint.health.show-details=always\nmanagement.endpoint.health.enabled=true\nmanagement.endpoint.routes.enabled=true\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("h3",{attrs:{id:"配置指定微服务的访问路径"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置指定微服务的访问路径"}},[s._v("#")]),s._v(" 配置指定微服务的访问路径")]),s._v(" "),e("ol",[e("li",[s._v("通过服务名配置（虚拟主机名）")])]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("zuul.routes.user-consumer"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/xxoo/**\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("配置前先访问，然后做对比。")]),s._v(" "),e("p",[s._v("2.自定义映射")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("zuul.routes.xx.path=/xx/**\nzuul.routes.xx.url=http://mashibing.com\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ol",{attrs:{start:"3"}},[e("li",[s._v(".自定义下的负载均衡")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("zuul.routes.xx.path=/xx/**\nzuul.routes.xx.service-id=cuid\n\ncuid.ribbon.listOfServers=localhost:82,localhost:83\nribbon.eureka.enabled=false\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("h3",{attrs:{id:"忽略微服务"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#忽略微服务"}},[s._v("#")]),s._v(" 忽略微服务")]),s._v(" "),e("p",[s._v("配置")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("zuul.ignored-services=user-provider\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"前缀"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#前缀"}},[s._v("#")]),s._v(" 前缀")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("zuul.prefix=/api/v1\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("带上前缀请求")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("zuul.strip-prefix=false\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"高可用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#高可用"}},[s._v("#")]),s._v(" 高可用")]),s._v(" "),e("p",[s._v("Nginx")])])}),[],!1,null,null,null);a.default=r.exports}}]);