(window.webpackJsonp=window.webpackJsonp||[]).push([[42],{681:function(s,a,v){"use strict";v.r(a);var e=v(3),_=Object(e.a)({},(function(){var s=this,a=s.$createElement,v=s._self._c||a;return v("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[v("h1",{attrs:{id:"redis基本特性及原理"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#redis基本特性及原理"}},[s._v("#")]),s._v(" Redis基本特性及原理")]),s._v(" "),v("h2",{attrs:{id:"io模型"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#io模型"}},[s._v("#")]),s._v(" IO模型")]),s._v(" "),v("p",[s._v("Redis采用Epoll的IO模型，epoll的原理详见系统IO的章节")]),s._v(" "),v("h2",{attrs:{id:"二进制安全"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#二进制安全"}},[s._v("#")]),s._v(" 二进制安全")]),s._v(" "),v("p",[v("strong",[s._v("Redis进程与客户端进行交互的时候，存取的是字节流。目的是保证数据不被破坏")])]),s._v(" "),v("div",{staticClass:"language- line-numbers-mode"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[s._v("set k1 中    // 默认shell连接方式是utf8\nstrlen k1   // 结果 3\nset k2 中   // 修改shell连接方式为gbk\nstrlen k2  // 结果 2 \n")])]),s._v(" "),v("div",{staticClass:"line-numbers-wrapper"},[v("span",{staticClass:"line-number"},[s._v("1")]),v("br"),v("span",{staticClass:"line-number"},[s._v("2")]),v("br"),v("span",{staticClass:"line-number"},[s._v("3")]),v("br"),v("span",{staticClass:"line-number"},[s._v("4")]),v("br")])]),v("h2",{attrs:{id:"数据库"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#数据库"}},[s._v("#")]),s._v(" 数据库")]),s._v(" "),v("ul",[v("li",[v("p",[s._v("Redis默认准备了16个库，（id为 0-15）")])]),s._v(" "),v("li",[v("p",[s._v("库的选择")]),s._v(" "),v("ul",[v("li",[v("p",[s._v("连接后使用select命令选择使用哪个库")]),s._v(" "),v("div",{staticClass:"language- line-numbers-mode"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[s._v("select id\n")])]),s._v(" "),v("div",{staticClass:"line-numbers-wrapper"},[v("span",{staticClass:"line-number"},[s._v("1")]),v("br")])])]),s._v(" "),v("li",[v("p",[s._v("连接时指定")]),s._v(" "),v("div",{staticClass:"language- line-numbers-mode"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[s._v("redis-cli -n id\n")])]),s._v(" "),v("div",{staticClass:"line-numbers-wrapper"},[v("span",{staticClass:"line-number"},[s._v("1")]),v("br")])])])])])]),s._v(" "),v("h2",{attrs:{id:"单机持久化"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#单机持久化"}},[s._v("#")]),s._v(" 单机持久化")]),s._v(" "),v("h3",{attrs:{id:"rdb"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#rdb"}},[s._v("#")]),s._v(" RDB")]),s._v(" "),v("ul",[v("li",[v("p",[s._v("原理")]),s._v(" "),v("p",[s._v("执行持久化时Redis会fork（）一个子进程来执行持久化。在执行fork的时候操作系统会使用写时复制（copy-on-write）策略，即fork函数发生的一刻父子进程共享同一内存数据，当父进程要更改其中某片数据时（如执行一个写命令 ），操作系统会将该片数据复制一份以保证子进程的数据不受影响，所以新的RDB文件存储的是执行fork那一刻的内存数据")]),s._v(" "),v("ul",[v("li",[v("p",[s._v("fork()")]),s._v(" "),v("p",[s._v("系统调用")])]),s._v(" "),v("li",[v("p",[s._v("cow( copy on write)")]),s._v(" "),v("p",[s._v("写时复制，内核机制")])])])]),s._v(" "),v("li",[v("p",[s._v("如何触发")]),s._v(" "),v("ul",[v("li",[v("p",[s._v("save命令")]),s._v(" "),v("p",[s._v("关机维护")])]),s._v(" "),v("li",[v("p",[s._v("bgsave命令")])]),s._v(" "),v("li",[v("p",[s._v("配置文件save")]),s._v(" "),v("p",[s._v("实际使用的bgsave")]),s._v(" "),v("p",[s._v("配置方法")]),s._v(" "),v("ul",[v("li",[v("p",[s._v("save 时间(秒) 操作数")]),s._v(" "),v("p",[s._v("如：save 900 1")])]),s._v(" "),v("li",[v("p",[s._v("关闭配置")]),s._v(" "),v("p",[s._v("save ''，或者直接删除")])]),s._v(" "),v("li",[v("p",[s._v("配置文件")]),s._v(" "),v("p",[s._v("dbfilename dump.rdb")])]),s._v(" "),v("li",[v("p",[s._v("路径")]),s._v(" "),v("p",[s._v("dir /var/lib/redis/6379")])])])])])]),s._v(" "),v("li",[v("p",[s._v("弊端")]),s._v(" "),v("ul",[v("li",[v("p",[s._v("不支持拉链，只存在一个rdb文件")])]),s._v(" "),v("li",[v("p",[s._v("丢失数据相对多一些")]),s._v(" "),v("p",[s._v("时点与时点之间窗口数据容易丢失")])])])]),s._v(" "),v("li",[v("p",[s._v("优势")]),s._v(" "),v("p",[s._v("类似java中的序列化恢复的速度相对快")])])]),s._v(" "),v("h3",{attrs:{id:"aof"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#aof"}},[s._v("#")]),s._v(" AOF")]),s._v(" "),v("ul",[v("li",[v("p",[s._v("原理")]),s._v(" "),v("ul",[v("li",[v("p",[s._v("Redis写操作记录到文件中")])]),s._v(" "),v("li",[v("p",[s._v("RDB和AOF可以同时开启")]),s._v(" "),v("ul",[v("li",[s._v("如果开启了AOF只会用AOF恢复")]),s._v(" "),v("li",[s._v("4.0以后AOF中包含RDB全量，增加记录新的写操作")])])])])]),s._v(" "),v("li",[v("p",[s._v("弊端")]),s._v(" "),v("ul",[v("li",[v("p",[s._v("体量无限变大，恢复慢")]),s._v(" "),v("ul",[v("li",[v("p",[s._v("hdfs,fsimage+edits.log 让日志只记录增量合并的过程")])]),s._v(" "),v("li",[v("p",[s._v("4.0以前--\x3e重写")]),s._v(" "),v("p",[s._v("删除抵消的命令，合并重复的命令，最终也是一个纯指令的日志文件")])]),s._v(" "),v("li",[v("p",[s._v("4.0以后--\x3e重写")]),s._v(" "),v("ul",[v("li",[s._v("将老的数据RDB到AOF文件中")]),s._v(" "),v("li",[s._v("将增量的以指令的方式Append到AOF中")])])])])]),s._v(" "),v("li",[v("p",[s._v("文件写会触发IO，存在丢失buffer数据的问题")]),s._v(" "),v("p",[s._v("append only mode")]),s._v(" "),v("ul",[v("li",[s._v("配置刷盘的频率\n"),v("ul",[v("li",[s._v("appendfsync always")]),s._v(" "),v("li",[s._v("appendfsync everysec")]),s._v(" "),v("li",[s._v("appendfsync no")])])])])])])]),s._v(" "),v("li",[v("p",[s._v("优势")]),s._v(" "),v("ul",[v("li",[s._v("丢数据少")]),s._v(" "),v("li",[s._v("4.0以后的AOF是一个混合体，利用了RDB的快也利用了日志的全量")])])]),s._v(" "),v("li",[v("p",[s._v("什么时候触发合并bgrewriteaof")]),s._v(" "),v("div",{staticClass:"language- line-numbers-mode"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[s._v("auto-aof-rewrite-percentage 100\nauto-aof-rewrite-min-size 64mb\n")])]),s._v(" "),v("div",{staticClass:"line-numbers-wrapper"},[v("span",{staticClass:"line-number"},[s._v("1")]),v("br"),v("span",{staticClass:"line-number"},[s._v("2")]),v("br")])]),v("p",[s._v("redis在一次重写万之后会记录这次重写后aof大小，如果之前没有记录就以当前aof大小为准。在下次做readonlysync时判断aof文件增长比例，指当前aof文件比上次重写的增长比例大小。如果大于这个比例就触发重写。")])]),s._v(" "),v("li",[v("p",[s._v("实操验证")]),s._v(" "),v("ul",[v("li",[v("p",[s._v("readonly.aof文件内容协议")]),s._v(" "),v("div",{staticClass:"language- line-numbers-mode"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[s._v("*2\n$6\nSELECT\n$1\n0\n*3\n$3\nset\n$2\nk1\n$1\n1\n")])]),s._v(" "),v("div",{staticClass:"line-numbers-wrapper"},[v("span",{staticClass:"line-number"},[s._v("1")]),v("br"),v("span",{staticClass:"line-number"},[s._v("2")]),v("br"),v("span",{staticClass:"line-number"},[s._v("3")]),v("br"),v("span",{staticClass:"line-number"},[s._v("4")]),v("br"),v("span",{staticClass:"line-number"},[s._v("5")]),v("br"),v("span",{staticClass:"line-number"},[s._v("6")]),v("br"),v("span",{staticClass:"line-number"},[s._v("7")]),v("br"),v("span",{staticClass:"line-number"},[s._v("8")]),v("br"),v("span",{staticClass:"line-number"},[s._v("9")]),v("br"),v("span",{staticClass:"line-number"},[s._v("10")]),v("br"),v("span",{staticClass:"line-number"},[s._v("11")]),v("br"),v("span",{staticClass:"line-number"},[s._v("12")]),v("br")])]),v("ul",[v("li",[v("p",[s._v("*2")]),s._v(" "),v("p",[s._v("该条指令包含两个元素 select 0")])]),s._v(" "),v("li",[v("p",[s._v("$6")]),s._v(" "),v("p",[s._v("元素包含6个字符")])])])]),s._v(" "),v("li",[v("p",[s._v("redis-check-rdb dump.rdb")]),s._v(" "),v("p",[s._v("验证rdb文件的完整性")])]),s._v(" "),v("li",[v("p",[s._v("bgrewriteaof")])])])])])])}),[],!1,null,null,null);a.default=_.exports}}]);