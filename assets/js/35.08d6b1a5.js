(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{671:function(s,a,t){"use strict";t.r(a);var n=t(3),r=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"链路追踪"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#链路追踪"}},[s._v("#")]),s._v(" 链路追踪")]),s._v(" "),t("p",[t("img",{attrs:{src:"/Users/lijinling/Documents/svn/myRepo/Coding/DayDayUp/Architect/SpringCloud/images/5.png",alt:"img"}})]),s._v(" "),t("h2",{attrs:{id:"分布式计算八大误区"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#分布式计算八大误区"}},[s._v("#")]),s._v(" 分布式计算八大误区")]),s._v(" "),t("p",[s._v("网络可靠。")]),s._v(" "),t("p",[s._v("延迟为零。")]),s._v(" "),t("p",[s._v("带宽无限。")]),s._v(" "),t("p",[s._v("网络绝对安全。")]),s._v(" "),t("p",[s._v("网络拓扑不会改变。")]),s._v(" "),t("p",[s._v("必须有一名管理员。")]),s._v(" "),t("p",[s._v("传输成本为零。")]),s._v(" "),t("p",[s._v("网络同质化。（操作系统，协议）")]),s._v(" "),t("h2",{attrs:{id:"链路追踪的必要性"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#链路追踪的必要性"}},[s._v("#")]),s._v(" 链路追踪的必要性")]),s._v(" "),t("p",[s._v("如果能跟踪每个请求，中间请求经过哪些微服务，请求耗时，网络延迟，业务逻辑耗时等。我们就能更好地分析系统瓶颈、解决系统问题。因此链路跟踪很重要。")]),s._v(" "),t("p",[s._v("我们自己思考解决方案：在调用前后加时间戳。捕获异常。")]),s._v(" "),t("p",[s._v("链路追踪目的：解决错综复杂的服务调用中链路的查看。排查慢服务。")]),s._v(" "),t("p",[s._v("市面上链路追踪产品，大部分基于google的Dapper论文。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("zipkin,twitter开源的。是严格按照谷歌的Dapper论文来的。\n\npinpoint 韩国的 Naver公司的。\n\nCat 美团点评的\n\nEagleEye 淘宝的\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("h2",{attrs:{id:"链路追踪要考虑的几个问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#链路追踪要考虑的几个问题"}},[s._v("#")]),s._v(" 链路追踪要考虑的几个问题")]),s._v(" "),t("ol",[t("li",[s._v("探针的性能消耗。尽量不影响 服务本尊。")]),s._v(" "),t("li",[s._v("易用。开发可以很快接入，别浪费太多精力。")]),s._v(" "),t("li",[s._v("数据分析。要实时分析。维度足够。")])]),s._v(" "),t("h2",{attrs:{id:"sleuth"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#sleuth"}},[s._v("#")]),s._v(" Sleuth")]),s._v(" "),t("h3",{attrs:{id:"简介"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[s._v("#")]),s._v(" 简介")]),s._v(" "),t("p",[s._v("Sleuth是Spring cloud的分布式跟踪解决方案。")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("span(跨度)，基本工作单元。一次链路调用，创建一个span，")]),s._v(" "),t("p",[s._v("span用一个64位id唯一标识。包括：id，描述，时间戳事件，spanId,span父id。")]),s._v(" "),t("p",[s._v("span被启动和停止时，记录了时间信息，初始化span叫：root span，它的span id和trace id相等。")])]),s._v(" "),t("li",[t("p",[s._v("trace(跟踪)，一组共享“root span”的span组成的树状结构 称为 trace，trace也有一个64位ID，trace中所有span共享一个trace id。类似于一颗 span 树。")])]),s._v(" "),t("li",[t("p",[s._v("annotation（标签），annotation用来记录事件的存在，其中，核心annotation用来定义请求的开始和结束。")]),s._v(" "),t("ul",[t("li",[s._v("CS(Client Send客户端发起请求)。客户端发起请求描述了span开始。")]),s._v(" "),t("li",[s._v("SR(Server Received服务端接到请求)。服务端获得请求并准备处理它。SR-CS=网络延迟。")]),s._v(" "),t("li",[s._v("SS（Server Send服务器端处理完成，并将结果发送给客户端）。表示服务器完成请求处理，响应客户端时。SS-SR=服务器处理请求的时间。")]),s._v(" "),t("li",[s._v("CR（Client Received 客户端接受服务端信息）。span结束的标识。客户端接收到服务器的响应。CR-CS=客户端发出请求到服务器响应的总时间。")])])])]),s._v(" "),t("p",[s._v("其实数据结构是一颗树，从root span 开始。")]),s._v(" "),t("h3",{attrs:{id:"使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用"}},[s._v("#")]),s._v(" 使用")]),s._v(" "),t("h4",{attrs:{id:"sleuth单独"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#sleuth单独"}},[s._v("#")]),s._v(" Sleuth单独")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("pom")]),s._v(" "),t("p",[s._v("每个需要监控的系统")])])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("-- 引入sleuth依赖 --"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("dependency"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\t\t\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("groupId"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("org.springframework.cloud"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/groupId"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\t\t\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("artifactId"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("spring-cloud-starter-sleuth"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/artifactId"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/dependency"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("测试点：")]),s._v(" "),t("ol",[t("li",[s._v("启动eureka 7900，service-sms 8002，api-driver 9002.")]),s._v(" "),t("li",[s._v("访问一次。看日志结果。")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("api-driver,1a409c98e7a3cdbf,1a409c98e7a3cdbf,true"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("服务名称，traceId（一条请求调用链中 唯一ID），spanID（基本的工作单元，获取数据等），是否让zipkin收集和展示此信息"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n看下游\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("service-sms,1a409c98e7a3cdbf,b3d93470b5cf8434,true"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\ntraceId， 是一样的。\n\n服务名必须得写。\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("h4",{attrs:{id:"zipkin"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#zipkin"}},[s._v("#")]),s._v(" zipkin")]),s._v(" "),t("p",[s._v("上面拍错看日志，很原始。刀耕火种，加入利器 zipkin。")]),s._v(" "),t("p",[s._v("zipkin是twitter开源的分布式跟踪系统。")]),s._v(" "),t("p",[s._v("原理收集系统的时序数据，从而追踪微服务架构中系统延时等问题。还有一个友好的界面。")]),s._v(" "),t("p",[s._v("由4个部分组成：")]),s._v(" "),t("p",[s._v("Collector、Storage、Restful API、Web UI组成")]),s._v(" "),t("p",[s._v("采集器，存储器，接口，UI。")]),s._v(" "),t("p",[s._v("原理：")]),s._v(" "),t("p",[s._v("sleuth收集跟踪信息通过http请求发送给zipkin server，zipkin将跟踪信息存储，以及提供RESTful API接口，zipkin ui通过调用api进行数据展示。")]),s._v(" "),t("p",[s._v("默认内存存储，可以用mysql，ES等存储。")]),s._v(" "),t("p",[s._v("操作步骤：")]),s._v(" "),t("ol",[t("li",[s._v("每个需要监听的服务的pom中添加。")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("-- zipkin --"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("dependency"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\t\t\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("groupId"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("org.springframework.cloud"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/groupId"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\t\t\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("artifactId"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("spring-cloud-starter-zipkin"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/artifactId"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/dependency"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("ol",{attrs:{start:"2"}},[t("li",[s._v("每个需要监听的服务yml中")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("spring:\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#zipkin")]),s._v("\n  zipkin:\n    base-url: http://localhost:9411/\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#采样比例1")]),s._v("\n  sleuth:\n    sampler:\n      rate: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("ol",{attrs:{start:"3"}},[t("li",[s._v("启动zipkin。")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("jar包下载：curl -sSL https://zipkin.io/quickstart.sh "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v(" -s\n我放到了 目录：C:"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("github"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("online-taxi-demo  下面。\n\n\njava -jar zipkin.jar\n\n或者docker：\ndocker run -d -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9411")]),s._v(":9411 openzipkin/zipkin\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("h1",{attrs:{id:""}},[t("a",{staticClass:"header-anchor",attrs:{href:"#"}},[s._v("#")])])])}),[],!1,null,null,null);a.default=r.exports}}]);